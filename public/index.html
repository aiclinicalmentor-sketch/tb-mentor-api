<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TB Mentor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #020617;
      --panel: #020617;
      --surface: #020617;
      --text: #f9fbff;
      --muted: #9ca3c7;
      --accent: #4cc9f0;
      --accent-strong: #7c3aed;
      --border: rgba(148, 163, 184, 0.6);
      --border-subtle: rgba(148, 163, 184, 0.35);
      --shadow: 0 20px 60px rgba(15, 23, 42, 0.8);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Space Grotesk", system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(circle at 18% 18%, rgba(124, 58, 237, 0.2), transparent 45%),
        radial-gradient(circle at 82% 6%, rgba(76, 201, 240, 0.2), transparent 40%),
        var(--bg);
      color: var(--text);
      padding: 32px 16px 48px;
      display: flex;
      justify-content: center;
    }
    .shell {
      width: 100%;
      max-width: 1200px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid var(--border-subtle);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 24px;
      backdrop-filter: blur(10px);
    }
    header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    h1 { margin: 0; font-size: 30px; letter-spacing: -0.03em; }
    .badge {
      background: rgba(76, 201, 240, 0.18);
      color: var(--accent);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.08em;
      border: 1px solid rgba(76, 201, 240, 0.75);
      text-transform: uppercase;
    }
    .lead {
      color: var(--muted);
      margin: 6px 0 0;
      line-height: 1.6;
      max-width: 780px;
      font-size: 15px;
    }
    .lead strong {
      color: var(--text);
      font-weight: 500;
    }

    .mode-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0 18px;
      align-items: center;
      justify-content: space-between;
    }
    .mode-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .mode-pill {
      display: inline-flex;
      flex-direction: column;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      min-width: 130px;
    }
    .mode-pill-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }
    .mode-pill-value {
      font-size: 13px;
    }
    .mode-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .toggle-wrap {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
    }
    .toggle-wrap input {
      accent-color: var(--accent);
      cursor: pointer;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.3fr);
      gap: 18px;
      margin-top: 4px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
    }
    .chat {
      display: flex;
      flex-direction: column;
      gap: 10px;
      height: 100%;
    }
    .chat-window {
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 14px 14px 10px;
      height: 460px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }
    .msg-block {
      margin-bottom: 10px;
    }
    .msg {
      max-width: 86%;
      padding: 10px 13px;
      border-radius: 12px;
      line-height: 1.5;
      font-size: 15px;
      white-space: pre-wrap;
      word-break: break-word;
      border: 1px solid transparent;
    }
    .msg.user {
      margin-left: auto;
      background: linear-gradient(135deg, #4cc9f0, #7c3aed);
      color: #020617;
      border-color: rgba(15, 23, 42, 0.8);
    }
    .msg.assistant {
      background: rgba(15, 23, 42, 0.95);
      border-color: var(--border-subtle);
    }
    .msg.system {
      background: rgba(15, 23, 42, 0.8);
      border-style: dashed;
      border-color: var(--border-subtle);
      color: var(--muted);
    }
    .msg.thinking {
      font-style: italic;
      color: var(--muted);
      border-style: dashed;
      border-color: rgba(148, 163, 184, 0.5);
    }
    .assistant-meta {
      margin-top: 4px;
      margin-left: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px 6px;
      font-size: 11px;
      color: var(--muted);
    }
    .tool-pill {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.98);
      font-size: 11px;
      white-space: nowrap;
    }
    .assistant-actions {
      margin-top: 6px;
      margin-left: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 12px;
    }
    .qa-btn {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      padding: 4px 10px;
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.1s ease;
    }
    .qa-btn:hover {
      background: rgba(15, 23, 42, 1);
      border-color: rgba(76, 201, 240, 0.8);
      color: var(--text);
      transform: translateY(-0.5px);
    }
    .reasoning-block {
      margin-top: 6px;
      margin-left: 4px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.96);
      font-size: 13px;
      color: var(--muted);
    }

    .input-area {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      margin-top: 2px;
    }
    textarea {
      flex: 1;
      min-height: 80px;
      max-height: 140px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      padding: 12px;
      font-size: 15px;
      line-height: 1.5;
      resize: vertical;
      transition: border 0.2s, box-shadow 0.2s;
    }
    textarea::placeholder {
      color: rgba(148, 163, 184, 0.9);
    }
    textarea:focus {
      outline: none;
      border-color: rgba(76, 201, 240, 0.9);
      box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.25);
    }
    button {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #020617;
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 12px 28px rgba(124, 58, 237, 0.4);
      transition: transform 0.15s ease, box-shadow 0.2s ease, opacity 0.2s ease;
      white-space: nowrap;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 34px rgba(124, 58, 237, 0.5);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    #resetBtn {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border-subtle);
      box-shadow: none;
      padding-inline: 12px;
      font-weight: 500;
    }
    #resetBtn:hover {
      color: var(--text);
      border-color: rgba(148, 163, 184, 0.9);
      background: rgba(15, 23, 42, 0.8);
    }

    .status {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
      min-height: 18px;
    }
    .error { color: #fecaca; }
    .success { color: #bbf7d0; }
    .row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .side-panel {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .section-title {
      margin: 0;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
    }
    .snapshot-help {
      margin: 4px 0 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .snapshot-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 10px;
      margin-bottom: 8px;
    }
    .snapshot-grid label {
      font-size: 12px;
      color: var(--muted);
      display: block;
      margin-bottom: 2px;
    }
    .snapshot-grid input,
    .snapshot-grid textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      padding: 6px 8px;
      font-size: 13px;
      resize: vertical;
      min-height: 28px;
    }
    .snapshot-grid textarea {
      grid-column: 1 / -1;
      min-height: 44px;
    }
    .snapshot-grid input:focus,
    .snapshot-grid textarea:focus {
      outline: none;
      border-color: rgba(76, 201, 240, 0.9);
      box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.25);
    }
    .snapshot-footer {
      margin-top: 4px;
      font-size: 11px;
      color: var(--muted);
    }

    @media (max-width: 960px) {
      .grid {
        grid-template-columns: 1fr;
      }
      .chat-window {
        height: 420px;
      }
      .mode-bar {
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div>
        <div class="row" style="margin-top:0">

          <h1>TB Mentor</h1>
        </div>
        <p class="lead">
          Hold a conversation about a patient. <strong>Include age, weight, HIV status, pregnancy, TB history, comorbidities, current regimen and key labs.</strong>
          Ask specific questions (diagnosis, regimen choice, drug interactions, monitoring, or follow-up).
        </p>
      </div>
      <button id="resetBtn">New conversation</button>
    </header>

    <div class="mode-bar">
      <div class="mode-pills">
        <div class="mode-pill">
          <span class="mode-pill-label">Mode</span>
          <span class="mode-pill-value" id="modeLabel">Ask / Clarify</span>
        </div>
        <div class="mode-pill">
          <span class="mode-pill-label">Site setting</span>
          <span class="mode-pill-value" id="siteLabel">MDR-TB referral hospital</span>
        </div>
        <div class="mode-pill">
          <span class="mode-pill-label">Risk posture</span>
          <span class="mode-pill-value" id="riskLabel">Standard</span>
        </div>
        <div class="mode-pill">
          <span class="mode-pill-label">Learner level</span>
          <span class="mode-pill-value" id="learnerLabel">Medical officer</span>
        </div>
      </div>
      <div class="mode-right">
        <label class="toggle-wrap">
          <input type="checkbox" id="reasoningToggle">
          <span>Show reasoning summary (when available)</span>
        </label>
      </div>
    </div>

    <div class="grid">
      <div class="card chat">
        <div class="chat-window" id="chatWindow"></div>
        <div class="input-area">
          <textarea
            id="prompt"
            placeholder="Type here…"
          ></textarea>
          <button id="askBtn">Send</button>
        </div>
        <div class="status" id="status"></div>
      </div>

      <div class="card side-panel">
        <div>
          <p class="section-title">Case snapshot</p>
          <p class="snapshot-help" id="caseSummaryText"></p>
          <p class="snapshot-help">
            Key facts stay pinned here. You can edit at any time; this does not change previous messages.
          </p>
          <div class="snapshot-grid">
            <div>
              <label for="snapAge">Age / sex</label>
              <input id="snapAge" type="text" placeholder="e.g., 30 y M">
            </div>
            <div>
              <label for="snapWeight">Weight</label>
              <input id="snapWeight" type="text" placeholder="e.g., 54 kg">
            </div>
            <div>
              <label for="snapHiv">HIV status</label>
              <input id="snapHiv" type="text" placeholder="e.g., HIV+, CD4 220">
            </div>
            <div>
              <label for="snapPreg">Pregnancy</label>
              <input id="snapPreg" type="text" placeholder="e.g., 1st trimester">
            </div>
            <div>
              <label for="snapTb">TB profile</label>
              <input id="snapTb" type="text" placeholder="e.g., new RR-TB, no SL exposure">
            </div>
            <div>
              <label for="snapComorbid">Comorbidities</label>
              <input id="snapComorbid" type="text" placeholder="e.g., diabetes, CKD">
            </div>
            <div>
              <label for="snapRegimen">Current regimen</label>
              <textarea id="snapRegimen" placeholder="e.g., BDQ LFX LZD Cfz, start date, planned duration"></textarea>
            </div>
            <div>
              <label for="snapDanger">Danger signs / labs</label>
              <textarea id="snapDanger" placeholder="e.g., RR 36, SpO2 90%, Cr 1.8, QTc 470 ms"></textarea>
            </div>
          </div>
          <p class="snapshot-footer">
            As you describe the case, the mentor will try to pre-fill age/HIV/pregnancy fields from your text.
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const promptEl = document.getElementById("prompt");
    const askBtn = document.getElementById("askBtn");
    const resetBtn = document.getElementById("resetBtn");
    const chatWindow = document.getElementById("chatWindow");
    const statusEl = document.getElementById("status");
    const reasoningToggle = document.getElementById("reasoningToggle");

    const snapAge = document.getElementById("snapAge");
    const snapWeight = document.getElementById("snapWeight");
    const snapHiv = document.getElementById("snapHiv");
    const snapPreg = document.getElementById("snapPreg");
    const snapTb = document.getElementById("snapTb");
    const snapComorbid = document.getElementById("snapComorbid");
    const snapRegimen = document.getElementById("snapRegimen");
    const snapDanger = document.getElementById("snapDanger");
    const caseSummaryText = document.getElementById("caseSummaryText");

    let history = [];
    let sending = false;
    let showReasoning = false;
    let thinkingNode = null;

    function scrollToBottom() {
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function createMessageBlock(msg, index) {
      const block = document.createElement("div");
      block.className = "msg-block";

      const bubble = document.createElement("div");
      let baseClass = "msg " + (msg.role || "assistant");
      if (msg.thinking) {
        baseClass += " thinking";
      }
      bubble.className = baseClass;
      bubble.textContent = msg.content;
      block.appendChild(bubble);

      if (msg.role === "assistant" && !msg.thinking) {
        if (Array.isArray(msg.toolsUsed) && msg.toolsUsed.length > 0) {
          const meta = document.createElement("div");
          meta.className = "assistant-meta";
          const label = document.createElement("span");
          label.textContent = "Used:";
          meta.appendChild(label);

          msg.toolsUsed.forEach((tool) => {
            const pill = document.createElement("span");
            pill.className = "tool-pill";
            pill.textContent = tool;
            meta.appendChild(pill);
          });

          block.appendChild(meta);
        }

        if (showReasoning && msg.reasoning) {
          const reasoningDiv = document.createElement("div");
          reasoningDiv.className = "reasoning-block";
          reasoningDiv.textContent = msg.reasoning;
          block.appendChild(reasoningDiv);
        }

        const actions = document.createElement("div");
        actions.className = "assistant-actions";
        actions.dataset.index = index;

        const followBtn = document.createElement("button");
        followBtn.className = "qa-btn";
        followBtn.type = "button";
        followBtn.textContent = "Ask follow-up";
        followBtn.addEventListener("click", () => handleQuickAction("followup", index));

        const summaryBtn = document.createElement("button");
        summaryBtn.className = "qa-btn";
        summaryBtn.type = "button";
        summaryBtn.textContent = "Summarize";
        summaryBtn.addEventListener("click", () => handleQuickAction("summarize", index));

        const planBtn = document.createElement("button");
        planBtn.className = "qa-btn";
        planBtn.type = "button";
        planBtn.textContent = "Create plan";
        planBtn.addEventListener("click", () => handleQuickAction("plan", index));

        actions.appendChild(followBtn);
        actions.appendChild(summaryBtn);
        actions.appendChild(planBtn);

        block.appendChild(actions);
      }

      return block;
    }

    function renderMessages() {
      chatWindow.innerHTML = "";
      history.forEach((m, i) => {
        const block = createMessageBlock(m, i);
        chatWindow.appendChild(block);
      });
      scrollToBottom();
    }

    function setStatus(text, className) {
      statusEl.textContent = text || "";
      statusEl.className = "status" + (className ? " " + className : "");
    }

    function addThinkingBubble() {
      removeThinkingBubble();
      const block = document.createElement("div");
      block.className = "msg-block";
      const bubble = document.createElement("div");
      bubble.className = "msg assistant thinking";
      bubble.textContent = "Thinking…";
      block.appendChild(bubble);
      chatWindow.appendChild(block);
      thinkingNode = block;
      scrollToBottom();
    }

    function removeThinkingBubble() {
      if (thinkingNode && thinkingNode.parentNode) {
        thinkingNode.parentNode.removeChild(thinkingNode);
      }
      thinkingNode = null;
    }

    function addErrorMessage(friendlyText) {
      history.push({ role: "system", content: friendlyText });
      renderMessages();
    }

    function updateSnapshotFromMessage(text) {
      if (!text) return;

      const ageMatch =
        text.match(/(\d{1,2})\s*-\s*year-old/i) ||
        text.match(/(\d{1,2})\s*year[s]?\s*old/i) ||
        text.match(/(\d{1,2})\s*(yo|y\/o)\b/i);
      if (ageMatch && !snapAge.value) {
        snapAge.value = ageMatch[1] + " y";
      }

      const weightMatch = text.match(/(\d{1,3})\s?(kg|kgs|kilograms?)/i);
      if (weightMatch && !snapWeight.value) {
        snapWeight.value = weightMatch[1] + " kg";
      }

      const hivPosMatch = text.match(/\bHIV\s*(\+|positive)/i);
      const hivNegMatch = text.match(/\bHIV\s*(-|negative)/i);
      if (!snapHiv.value) {
        if (hivPosMatch) snapHiv.value = "HIV+";
        else if (hivNegMatch) snapHiv.value = "HIV-negative";
      }

      const pregMatch = text.match(/pregnan\w*/i);
      if (pregMatch && !snapPreg.value) {
        snapPreg.value = "Pregnant";
      }
    }

    async function sendMessage(explicitMessage) {
      if (sending) return;
      const raw = explicitMessage != null ? explicitMessage : promptEl.value;
      const message = (raw || "").trim();
      if (!message) {
        setStatus("Please enter a case and question.", "error");
        return;
      }

      sending = true;
      askBtn.disabled = true;
      setStatus("", "");

      if (explicitMessage == null) {
        updateSnapshotFromMessage(message);
      }

      history.push({ role: "user", content: message });
      renderMessages();
      if (explicitMessage == null) {
        promptEl.value = "";
      }

      addThinkingBubble();

      try {
        const convoForApi = history.filter(
          (h) => h.role === "user" || h.role === "assistant"
        );

        const res = await fetch("/api/tb-mentor", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, history: convoForApi })
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const errText = data?.error || "Request failed.";
          let friendly = "Something went wrong. You can retry or rephrase the question.";
          if (errText.includes("tb-rag-query")) {
            friendly = "Guideline retrieval failed (tb-rag-query). You can retry, or continue with a more focused question.";
          } else if (errText.includes("tb_peds_tda")) {
            friendly = "The pediatric TB algorithm (TDA) service failed. You may need to retry or calculate the score manually.";
          }
          removeThinkingBubble();
          setStatus(errText, "error");
          addErrorMessage(friendly);
          return;
        }

        const output =
          typeof data.output === "string"
            ? data.output
            : data.output?.text || "No content returned.";

        const toolsUsed = data.toolsUsed || data.tools || [];
        const reasoning =
          data.reasoningSummary || data.reasoning_summary || data.reasoning || null;

        const caseSummary = data.caseSummary || null;
        const snapshot = data.snapshot || null;

        if (caseSummaryText) {
          caseSummaryText.textContent = caseSummary || "";
        }

        if (snapshot) {
          if (!snapAge.value && snapshot.ageSex) snapAge.value = snapshot.ageSex;
          if (!snapWeight.value && snapshot.weight) snapWeight.value = snapshot.weight;
          if (!snapHiv.value && snapshot.hiv) snapHiv.value = snapshot.hiv;
          if (!snapPreg.value && snapshot.pregnancy) snapPreg.value = snapshot.pregnancy;
          if (!snapTb.value && snapshot.tbProfile) snapTb.value = snapshot.tbProfile;
          if (!snapComorbid.value && snapshot.comorbidities) snapComorbid.value = snapshot.comorbidities;
          if (!snapRegimen.value && snapshot.regimen) snapRegimen.value = snapshot.regimen;
          if (!snapDanger.value && snapshot.danger) snapDanger.value = snapshot.danger;
        }

        history.push({
          role: "assistant",
          content: output,
          toolsUsed,
          reasoning
        });
        removeThinkingBubble();
        renderMessages();
        setStatus("Answer ready.", "success");
      } catch (err) {
        removeThinkingBubble();
        setStatus("Network or server error. Try again.", "error");
        addErrorMessage("Network or server error. If this keeps happening, check connectivity or try again later.");
      } finally {
        sending = false;
        askBtn.disabled = false;
        promptEl.focus();
      }
    }

    function handleQuickAction(type, index) {
      if (sending) return;
      const msg = history[index];
      if (!msg || msg.role !== "assistant") return;

      let text;
      if (type === "summarize") {
        text =
          "Please summarize your last answer in 3–5 bullet points for a busy clinician who is about to see this patient.";
      } else if (type === "plan") {
        text =
          "Convert your last answer into a concrete 1–3–5 step clinical plan, with drug names, doses (if appropriate), and a monitoring schedule.";
      } else if (type === "followup") {
        text =
          "Suggest and answer the most important follow-up question a frontline clinician should ask next for this case.";
      } else {
        return;
      }

      sendMessage(text);
    }

    askBtn.addEventListener("click", () => sendMessage());
    promptEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    resetBtn.addEventListener("click", () => {
      history = [];
      renderMessages();
      setStatus("", "");
      promptEl.value = "";
      promptEl.focus();
      snapAge.value = "";
      snapWeight.value = "";
      snapHiv.value = "";
      snapPreg.value = "";
      snapTb.value = "";
      snapComorbid.value = "";
      snapRegimen.value = "";
      snapDanger.value = "";
      if (caseSummaryText) caseSummaryText.textContent = "";
    });

    reasoningToggle.addEventListener("change", (e) => {
      showReasoning = e.target.checked;
      renderMessages();
    });

    setStatus("", "");
  </script>
</body>
</html>
